<!-- **_default/single** -->
<!DOCTYPE html>
<!-- **header** -->
<html lang="en-US">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		


    
        
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:image" content="https://www.companionway.net/img/fab_discover_sar.jpg" />
    


<meta name="twitter:title" content="Python fabric - Dynamically Discover Hosts" />



		<meta property="og:title" content="
             
                Python fabric - Dynamically Discover Hosts 
                &middot; 
             
            companionway" />
		<meta property="og:site_name" content="companionway" />
		<meta property="og:url" content="https://www.companionway.net/posts/using_fabric_to_dynamically_discover_hosts/" />
		
            <meta property="og:type" content="article" />
            <meta property="og:article:published_time" content="2019-03-12T09:18:43-04:00" />
            
		
		<title>
             
                Python fabric - Dynamically Discover Hosts 
                &middot; 
            
            companionway
        </title>
		<meta name="description" content="Meeting challenges with success!" />
		<meta name="HandheldFriendly" content="True" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="shortcut icon" href="https://www.companionway.net/img/favicon.ico">
		<link rel="apple-touch-icon" href="https://www.companionway.net/img/apple-touch-icon.png" />
		<!-- **styles** --> 
<link rel="stylesheet" type="text/css" href="https://www.companionway.net/css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="https://www.companionway.net/css/screen.css" />
<link rel="stylesheet" type="text/css" href="https://www.companionway.net/css/nav.css" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" type="text/css" href="../../css/custom.css" /> 
<!-- **EOB styles** -->

		
		
            <link href="https://www.companionway.netindex.xml" rel="alternate" type="application/rss+xml" title="companionway" />
		
		
    
    <meta name="generator" content="Hugo 0.80.0" />
    <link rel="canonical" href="https://www.companionway.net/posts/using_fabric_to_dynamically_discover_hosts/" />
    <!-- **fonts** --> 
<link ref="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=EB+Garamond" >
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Architects Daughter" >
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Tangerine|Open+Sans:300" >
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Philosopher">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
<!-- **EOB fonts** -->


        
            
            
                <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
                ga('create', 'UA-6970218-1', 'auto');
                ga('send', 'pageview');
                </script>
                
                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-6970218-1"></script>
                <script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());
                  gtag('config', 'UA-6970218-1');
                  gtag('set', {'user_id': 'USER_ID'}); 
                </script>
            
        
		
	</head>
	<body class="nav-closed">
        
		
<!-- **navigation** -->
<div class="nav">
	<h3 class="nav-title">Menu</h3>
	<a href="#" class="nav-close">
		<span class="hidden">Close</span>
	</a>
	<ul>
		
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../">Home</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../posts">Posts</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../pages/about/">About</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../pages/dlfiles/">Download Files</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../financial/">Financial</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../pages/links/">Links</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../articles/">Newspaper</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../posts/">Posts</a>
            </li>
		
            
            <li class="nav-opened" role="presentation">
                <a href="../../pages/projects/">Projects</a>
            </li>
		
	</ul>
	
        <a class="subscribe-button icon-feed" href="https://www.companionway.netindex.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>
<!-- **EOB navigation** -->

		<div class="site-wrapper">
<!-- **EOB header** -->




	<header class="main-header post-head" style="background-image: url(https://www.companionway.net/img/fab_discover_sar.jpg)">
		
		<nav class="main-nav overlay clearfix">
			
					
					<a class="blog-logo" href="https://www.companionway.net"><img src="https://www.companionway.net/img/sailboat.png" alt="Home" /></a>
					
					
					<a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
					
                </nav>
            </header>
            <div class="content_margin">
			<main class="content" role="main">
				<article class="posts">
					<header class="post-header">
						<h1 class="post-title">Python fabric - Dynamically Discover Hosts</h1>
						<small></small>
						<section class="post-meta">
							
							
						</section>
					</header>
					<section class="post-content">
						<p>Python fabric is a library tool for executing ssh commands remotely and responding as you desire.
I use python fabric for promoting code and web content. Essentially it is my devops tool to satisfy the
single most important devops rule: never log into a server! I use this over ansible or some of the other
devop tools because fabric only requires knowning one langauge and that is python.</p>
<p>My network changes a lot as I take servers down or stand them up frequently. Normally that would require changing
the environment roles (host lists) in my fabfile.py with all my changes. In the past I set aside certain IPs in my
network for each role. For example all my raspberry pies get named before I ever introduce them to the network.
Using the option &ndash;skip_bad_hosts with fabric is one way to do this but I really want more control.</p>
<p>So my fabfilei.py would has something like this in it:</p>
<pre><code>env.roledefs = {
      'rpis': ['rasp1', 'rasp2', 'rasp3', 'rasp4', 'rasp5', 'rasp6', 'rasp7'],
      'ubuntus': ['192.168.1.72'],
      'prsnl': ['artemis'],
      'rhat': ['f-node01'],
      'containers': ['u-node01', 'u-node02', 'f-node01'],
      'tst': ['rasp2', 'rasp7'],
      'websites': ['cos.tst', 'hype.companionway.net', 'companionway.net'],
      'to_level': {'dev': 'rasp5', 'stage': 'rasp2', 'prod': 'rasp1'}
  }
  env.roledefs['all'] = env.roledefs['rpis'] + env.roledefs['containers'] + env.roledefs['prsnl'] + env.roledefs['ubuntus']  # noqa
  env.roledefs['debs'] = env.roledefs['rpis'] + env.roledefs['containers'] + env.roledefs['prsnl'] + env.roledefs['ubuntus']  # noqa
</code></pre><p>Looks complicated but the point is that I have pre-listed servers whether they exist yet or not. In my /etc/hosts file all the hostname
have an IP assigned.</p>
<p>But what I really need is a way to build a list of servers that are up and have an ssh port open within a range of IPs on the network.
Specifically, I want fabric to scan 192.168.1.60 - 192.168.1.99 for live hosts with an open ssh port and then run a task against each.
That way a server can go up or be down and it has no bearing on fabric executing a selected task.</p>
<p>So here is my crude solution. If nothing else, it does demonstrate the flexibility of fabric.</p>
<p>This function is not declared as a task with the @task decorator. The purpose is just to test the socket on an IP</p>
<pre><code># ###########################
def check_socket(host, port, timeout=2, silent=False):
    # #######################
    &quot;&quot;&quot;
    This seems to work pretty well for me
    use:
    if check_socket(env.host, int(env.port)) is True:
        with warn_only():
            run('uname -a')
    Note: port must be a string!
    &quot;&quot;&quot;
    with closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as sock:
        sock.settimeout(timeout)
        if sock.connect_ex((host, port)) == 0:
              if not silent:
                  print()
                  print(&quot;-&quot;*60)
                  print(&quot;==== Host: [&quot; + host + &quot;] port: [&quot; + str(port) + &quot;] open ====&quot;)
                  print(&quot;-&quot;*60)
              return True
          else:
              if not silent:
                  print(&quot;=&quot;*60)
                  print(&quot;==== Host: [&quot; + host + &quot;] port: [&quot; + str(port) + &quot;] closed ====&quot;)
                  print(&quot;=&quot;*60)
                  print()
              return False
</code></pre><p>I also wrote a function to poll a range of IPs on a network segment.</p>
<pre><code># ########################################
def poll_netseg(netseg,start_ip,end_ip, silent=False):
   # ###################################
   &quot;&quot;&quot;
   discovery of live hosts on a selected port
   requires def check_socket
   netseg has to be 3 complete triplets including the last &quot;.&quot; for the network segment: eg 192.168.1.
   returns a list of hosts_open
   Note: displays dots as it polls to let the user know that it is in fact scanning IPs
   &quot;&quot;&quot;
   # flush=True is needed otherwise it won't print until the end of the poll (all at once which defeats the purpose)
   hosts_open = []
   print(f&quot;Checking network segment {netseg} from {start_ip} to {end_ip} &quot;, end='', flush=True)
   for ip in range(start_ip, end_ip):
       host_ip = netseg + str(ip)
       if not silent:
           print(&quot;. &quot;, end='', flush=True)
       if check_socket(host_ip, 22, timeout=1, silent=True) is True:
           hosts_open.append(host_ip)
   print()
   return hosts_open
</code></pre><p>So here is the meat in this sandwich. This function allows you to execute the task that you want on the hosts that were
discovered to be alive.</p>
<pre><code># ############################
@task
def discover(func=hname, start_ip=60,end_ip=99):
    # ########################
    &quot;&quot;&quot;
    purpose: discover hostnames dynamically and allow execution of selected function/task
    requires:
        poll_netseg()
            which requires setting env.netseg
            check_socket()
    input: be aware of the env.netseg, start_ip and end_ip
    &quot;&quot;&quot;
    live_hosts = poll_netseg(env.netseg, start_ip, end_ip)
    execute(func, hosts=live_hosts)
</code></pre><p>It defaults to running a task called hname which gets the hostname but that can be overridden on the command line.
First lets look at the task called hname just so you can see how this works.</p>
<pre><code># ###################
@task
def hname():
    # ###########
    &quot;&quot;&quot;
    eg: fab -R all hostname
    &quot;&quot;&quot;
    with hide('output'), settings(warn_only=True):
        out = run(&quot;hostname -f&quot;)
        print(out)
</code></pre><p>The sweet nectar in the discover task is that you can tell fabric to run any task that you have written.
Here is how I call a task called sar which runs sar (system activity report from the sysstat package)</p>
<pre><code># ######################
@task
def sar():
    # ################
    &quot;&quot;&quot;
    assures sar is installed and running and runs  sar | tail -10
    &quot;&quot;&quot;
    with settings(warn_only=True):
        with hide('output'), settings(warn_only=True):
          sar_out = sudo('sar')
        if sar_out.return_code != 0:
            print(f&quot;running sar failed so installing ...&quot;)
            sudo('apt install sysstat')
        r = sudo('grep -E &quot;^ENABLED=.*true&quot; /etc/default/sysstat')
        if r.return_code != 0:
            print(&quot;It appears sysstat is not ENABLED ... changing to true ...&quot;)
            sudo('sed -i -e \'/^ENABLED=&quot;false&quot;/s/false/true/\' /etc/default/sysstat')  # noqa
    sar_out = sar_out.splitlines(True)
    for l in sar_out_l:
        if l.strip() == &quot;&quot;:
					# skips blank lines
          print(l.rstrip())
</code></pre><p>To run that on all the live hosts:</p>
<pre><code>fab discover:func=sar
 # or
fab discover:sar
</code></pre><p>Done - Enjoy
-g-</p>
					</section>
					<footer class="post-footer">
						
						<figure class="author-image">
							<a class="img" href="https://www.companionway.net" style="background-image: url(https://www.companionway.net/img/sailboat.png)"><span class="hidden">Geoff McNamara's Picture</span></a>
						</figure>
						
						





<section class="author">
<h4><a href="https://www.companionway.net">Geoff McNamara</a></h4>

<p>&#34;Do not meddle in the affairs of wizards, for they are subtle and quick to anger.‚Äù J.R.R Tolkien</p>

<div class="author-meta">

<i class="fa fa-map-marker"></i>

<span class="author-location">Elizabeth City, NC
</span>


<i class="fa fa-link"></i>
<span class="author-link"><a href="https://www.companionway.net">https://www.companionway.net</a></span>


</div>
</section>


						

<section class="share">
	<h4>Share this posts</h4>
    
    <a class="bloglogo" href="https://twitter.com/geoffmcnamara" target="_blank">
        <i class="fab fa-twitter fa-1x" style="color:green;"></i>
    </a>
    &nbsp;
    
    
	 <a class="bloglogo" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.companionway.net%2fposts%2fusing_fabric_to_dynamically_discover_hosts%2f">
		<i class="fab fa-facebook fa-1x" style="color:blue;"></i>
	</a>
    &nbsp;
    
    
	 <a class="bloglogo" href="https://www.linkedin.com/in/companionway" target="_blank">
        <i class="fab fa-linkedin fa-1x" style="color:red;"></i>
    </a>
    &nbsp;
    
    
    <a class="bloglogo" href="https://github.com/geoffmcnamara" target="_blank">
        <i class="fab fa-github fa-1x" style="color:orange;"></i>
    </a>
    &nbsp;
    
</section>


						

<div id="disqus_thread"></div>
<i class="fa fa-comment"></i>



	<script type="text/javascript">
		



(function() { 
	var d = document, s = d.createElement('script');
	s.src = 'https://companionway-net.disqus.com/embed.js';
	s.setAttribute('data-timestamp', +new Date());
	(d.head || d.body).appendChild(s);
})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

	
	

					</footer>
				</article>
			</main>
        </div>
			<!-- **footer** -->
<!-- **scripts** -->
<script type="text/javascript" src="https://www.companionway.net/js/jquery.js"></script>
<script type="text/javascript" src="https://www.companionway.net/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="https://www.companionway.net/js/index.js"></script>
<script type="text/javascript" src="https://www.companionway.net/js/bootstrap.min.js"></script>
<script type="text/javascript" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script>
<script type="text/javascript" src="https://www.companionway.net/js/custom.js"></script>
<script id="dsq-count-scr" src="//companionway-net.disqus.com/count.js" async></script>
<!-- **EOB scripts** -->




<section class="share">
<hr>
	<center>
	<h4>Credits:</h4>
	
	<a href="https://www.netlify.com">
	  <img src="https://www.netlify.com/img/global/badges/netlify-color-bg.svg" height="62" title="netlify"/>
	</a>

	
	<a href="http://www.hugo.org">
        <img src="https://www.companionway.net/img/hugo-logo.png" height="62" title="Hugo"/>
	</a>

	
	<a href="https://github.com/w0rp/ale">
    <img src="https://www.companionway.net/img/ale-logo.jpg" height="62" title="vim Ale"/>
	</a>

	
	<a href="http://www.fabfile.org">
	  <img src="https://www.companionway.net/img/fabric-logo.png" height="62" title="Python Fabric"/>
	</a>

	

	
	<a href="https://github.com">
	  <img src="https://www.companionway.net/img/github-logo.jpg" height="62" title="github"/>
	</a>


	
  <a href="https://git-scm.com"/>
    <img src="https://www.companionway.net/img/git-logo.png" height="62" title="git"/>
	</a>

	
  <a href="https://codepen.io/"/>
    <img src="https://www.companionway.net/img/codepen-logo.png" height="62" title="codepen"/>
	</a>

	
	</center>
<hr>
</section>



<footer class="site-footer clearfix">
	<center>
		<div id="site-footer">
			<hr style="padding: 0px; margin: 0px;">
			<span>Powered by <a href="https://gohugo.io/">Hugo</a>.</span>
			<span>
				
				All rights reserved - companionway - 2019
				
			</span>
			<hr style="padding: 0px; margin: 0px;">
		</div>
	</center>
	

</footer>
</div> 
</body>
</html>
<!-- **EOB footer** -->

<!-- **EOB _default/single** -->
